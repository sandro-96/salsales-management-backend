[START]
// File: src/main/java/com/example/sales/repository/AuditLogRepository.java
package com.example.sales.repository;

import com.example.sales.model.AuditLog;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.List;

public interface AuditLogRepository extends MongoRepository<AuditLog, String> {
    List<AuditLog> findByTargetIdAndDeletedFalseOrderByCreatedAtDesc(String targetId);
}

// File: src/main/java/com/example/sales/repository/BranchRepository.java
package com.example.sales.repository;

import com.example.sales.model.Branch;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface BranchRepository extends MongoRepository<Branch, String> {
    Page<Branch> findByShopIdAndDeletedFalse(String shopId, Pageable pageable);
    Optional<Branch> findByIdAndDeletedFalse(String id);
    long countByShopIdAndDeletedFalse(String shopId);
}

// File: src/main/java/com/example/sales/repository/CustomerRepository.java
package com.example.sales.repository;

import com.example.sales.model.Customer;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.List;
import java.util.Optional;

public interface CustomerRepository extends MongoRepository<Customer, String> {

    List<Customer> findByShopIdAndBranchIdAndDeletedFalse(String shopId, String branchId);

    Optional<Customer> findByIdAndDeletedFalse(String id);
}

// File: src/main/java/com/example/sales/repository/InventoryTransactionRepository.java
package com.example.sales.repository;

import com.example.sales.model.InventoryTransaction;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;

public interface InventoryTransactionRepository extends MongoRepository<InventoryTransaction, String> {
    Page<InventoryTransaction> findByProductIdOrderByCreatedAtDesc(String productId, Pageable pageable);
}

// File: src/main/java/com/example/sales/repository/OrderRepository.java
package com.example.sales.repository;

import com.example.sales.constant.OrderStatus;
import com.example.sales.model.Order;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.Optional;

public interface OrderRepository extends MongoRepository<Order, String> {
    Optional<Order> findByIdAndDeletedFalse(String id);
    Page<Order> findByShopIdAndBranchIdAndStatusAndDeletedFalse(String shopId, String branchId, OrderStatus status, Pageable pageable);
    Page<Order> findByShopIdOrderByCreatedAtDesc(
            String shopId, Pageable pageable);
}

// File: src/main/java/com/example/sales/repository/ProductRepository.java
package com.example.sales.repository;

import com.example.sales.model.Product;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface ProductRepository extends MongoRepository<Product, String> {
    Optional<Product> findByIdAndDeletedFalse(String id);
    // T√¨m Product theo ID v√† ShopId
    Optional<Product> findByIdAndShopIdAndDeletedFalse(String id, String shopId);

    // T√¨m Product theo ShopId v√† SKU
    Optional<Product> findByShopIdAndSkuAndDeletedFalse(String shopId, String sku);

    // Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa Product theo ShopId v√† SKU
    boolean existsByShopIdAndSkuAndDeletedFalse(String shopId, String sku);

    // T√¨m ki·∫øm c√°c s·∫£n ph·∫©m chung theo t√™n ho·∫∑c danh m·ª•c (trong Product)
    // L∆∞u √Ω: ƒê√¢y l√† t√¨m ki·∫øm tr√™n ƒë·ªãnh nghƒ©a s·∫£n ph·∫©m chung, kh√¥ng ph·∫£i t·ªìn kho c·ª• th·ªÉ c·ªßa chi nh√°nh
    Optional<Product> findByShopIdAndNameContainingIgnoreCaseAndDeletedFalse(String shopId, String name);
    Optional<Product> findByShopIdAndCategoryContainingIgnoreCaseAndDeletedFalse(String shopId, String category);


    // Ch√∫ng ta s·∫Ω c·∫ßn th√™m c√°c ph∆∞∆°ng th·ª©c t√¨m ki·∫øm linh ho·∫°t h∆°n
    // Ho·∫∑c x√¢y d·ª±ng query ƒë·ªông trong ProductServiceImpl s·ª≠ d·ª•ng MongoTemplate ho·∫∑c Aggregation
}

// File: src/main/java/com/example/sales/repository/PromotionRepository.java
package com.example.sales.repository;

import com.example.sales.model.Promotion;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.List;
import java.util.Optional;

public interface PromotionRepository extends MongoRepository<Promotion, String> {
    List<Promotion> findByShopIdAndDeletedFalse(String shopId);

    Optional<Promotion> findByIdAndDeletedFalse(String id);

    Page<Promotion> findByShopIdAndBranchIdAndDeletedFalse(String shopId, String branchId, Pageable pageable);
}

// File: src/main/java/com/example/sales/repository/RefreshTokenRepository.java
package com.example.sales.repository;

import com.example.sales.model.RefreshToken;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.Optional;

public interface RefreshTokenRepository extends MongoRepository<RefreshToken, String> {
    Optional<RefreshToken> findByToken(String token);
}

// File: src/main/java/com/example/sales/repository/ShopRepository.java
package com.example.sales.repository;

import com.example.sales.constant.SubscriptionPlan;
import com.example.sales.model.Shop;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.data.mongodb.repository.Query;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

public interface ShopRepository extends MongoRepository<Shop, String> {
    Optional<Shop> findByOwnerIdAndDeletedFalse(String ownerId);
    Optional<Shop> findByIdAndDeletedFalse(String id);
    List<Shop> findByPlanExpiryBeforeAndPlanNot(LocalDateTime date, SubscriptionPlan plan);
    List<Shop> findByPlanExpiryBetween(LocalDateTime start, LocalDateTime end);
    boolean existsByNameAndDeletedFalse(String name);
    @Query("{ 'deleted': false, $or: [ { 'name': { $regex: ?0, $options: 'i' } }, { 'address': { $regex: ?0, $options: 'i' } } ] }")
    Page<Shop> findByKeyword(String keyword, Pageable pageable);
}

// File: src/main/java/com/example/sales/repository/ShopUserRepository.java
package com.example.sales.repository;

import com.example.sales.model.ShopUser;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.List;
import java.util.Optional;

public interface ShopUserRepository extends MongoRepository<ShopUser, String> {
    Optional<ShopUser> findByIdAndDeletedFalse(String id);

    Optional<ShopUser> findByShopIdAndUserIdAndDeletedFalse(String shopId, String userId);

    Page<ShopUser> findByUserIdAndDeletedFalse(String userId, Pageable pageable);

    Optional<ShopUser> findByShopIdAndUserIdAndBranchId(String shopId, String userId, String branchId);
    Optional<ShopUser> findByUserIdAndShopIdAndBranchIdAndDeletedFalse(String shopId, String userId, String branchId);

    List<ShopUser> findByUserIdAndShopIdAndDeletedFalse(String userId, String shopId);
}

// File: src/main/java/com/example/sales/repository/SubscriptionHistoryRepository.java
package com.example.sales.repository;

import com.example.sales.model.SubscriptionHistory;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.List;

public interface SubscriptionHistoryRepository extends MongoRepository<SubscriptionHistory, String> {
    List<SubscriptionHistory> findByShopIdOrderByCreatedAtDesc(String shopId);
}

// File: src/main/java/com/example/sales/repository/TableRepository.java
package com.example.sales.repository;

import com.example.sales.model.Table;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.List;
import java.util.Optional;

public interface TableRepository extends MongoRepository<Table, String> {

    List<Table> findByShopIdAndBranchIdAndDeletedFalse(String shopId, String branchId);
    Page<Table> findByShopIdAndBranchIdAndDeletedFalse(String shopId, String branchId, Pageable pageable);

    Optional<Table> findByIdAndDeletedFalse(String id);
}

// File: src/main/java/com/example/sales/repository/UserRepository.java
package com.example.sales.repository;

import com.example.sales.model.User;
import org.springframework.data.mongodb.repository.MongoRepository;

import java.util.Optional;

public interface UserRepository extends MongoRepository<User, String> {
    Optional<User> findByEmailAndDeletedFalse(String email);
    Optional<User> findByIdAndDeletedFalse(String id);
    Optional<User> findByVerificationTokenAndDeletedFalse(String token);
}

// File: src/main/java/com/example/sales/model/base/BaseEntity.java
package com.example.sales.model.base;

import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import org.springframework.data.annotation.CreatedBy;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedBy;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.mongodb.core.mapping.Field;

import java.time.LocalDateTime;

@Getter
@Setter
@ToString(exclude = {"createdBy", "updatedBy"})
@EqualsAndHashCode
@NoArgsConstructor
@AllArgsConstructor
public abstract class BaseEntity {

    @CreatedDate
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;

    @CreatedBy
    private String createdBy;

    @LastModifiedBy
    private String updatedBy;

    @Field("deleted")
    private boolean deleted = false;

    private LocalDateTime deletedAt;
}

// File: src/main/java/com/example/sales/model/AuditLog.java
package com.example.sales.model;

import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document("audit_logs")
public class AuditLog extends BaseEntity {

    @Id
    private String id;

    private String userId;
    private String shopId;

    private String targetId;     // ID c·ªßa Order ho·∫∑c Product
    private String targetType;   // "ORDER", "PRODUCT"

    private String action;       // PRICE_CHANGED, STATUS_UPDATED, etc.
    private String description;
}

// File: src/main/java/com/example/sales/model/Branch.java
package com.example.sales.model;

import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document("branches")
public class Branch extends BaseEntity {

    @Id
    private String id;

    private String shopId;
    private String name;
    private String address;
    private String phone;

    @Builder.Default
    private boolean active = true;
}

// File: src/main/java/com/example/sales/model/Customer.java
package com.example.sales.model;

import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document("customers")
public class Customer extends BaseEntity {

    @Id
    private String id;

    private String userId;     // Ch·ªß s·ªü h·ªØu
    private String name;
    private String phone;
    private String email;
    private String address;
    private String note;
    private String shopId;
    private String branchId;   // C√≥ th·ªÉ null n·∫øu kh√¥ng ph√¢n bi·ªát chi nh√°nh
}

// File: src/main/java/com/example/sales/model/InventoryTransaction.java
package com.example.sales.model;

import com.example.sales.constant.InventoryType;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Document("inventory_transactions")
public class InventoryTransaction extends BaseEntity {

    @Id
    private String id;

    private String shopId;
    private String branchId;
    private String productId;

    private InventoryType type;  // IMPORT, EXPORT, ADJUSTMENT

    private int quantity;

    private String note;

    private String referenceId;  // Li√™n k·∫øt ƒë∆°n h√†ng, phi·∫øu nh·∫≠p, v.v.
}

// File: src/main/java/com/example/sales/model/Order.java
package com.example.sales.model;

import com.example.sales.constant.OrderStatus;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import java.time.LocalDateTime;
import java.util.List;

@Getter
@Setter
@ToString(exclude = "items") // üëà Quan tr·ªçng: kh√¥ng in danh s√°ch item
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document("orders")
public class Order extends BaseEntity {
    @Id
    private String id;

    private String shopId;
    private String branchId;
    private String tableId;
    private String userId;

    private List<OrderItem> items;

    private double totalPrice;
    private double totalAmount;

    @Builder.Default
    private OrderStatus status = OrderStatus.PENDING;

    private String paymentId;
    private String paymentMethod;
    private LocalDateTime paymentTime;
    private boolean isPaid;

    private String note;
}

// File: src/main/java/com/example/sales/model/OrderItem.java
package com.example.sales.model;

import lombok.*;

@Getter
@Setter
@ToString
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class OrderItem {
    private String productId;       // ID c·ªßa Product (master product)
    private String branchProductId; // ID c·ªßa BranchProduct (s·∫£n ph·∫©m c·ª• th·ªÉ t·∫°i chi nh√°nh)
    private String productName;
    private int quantity;
    private double price;             // Gi√° g·ªëc t·∫°i th·ªùi ƒëi·ªÉm ƒë·∫∑t h√†ng
    private double priceAfterDiscount; // Gi√° sau khi √°p d·ª•ng khuy·∫øn m√£i
    private String appliedPromotionId; // ID c·ªßa khuy·∫øn m√£i ƒë√£ √°p d·ª•ng
}

// File: src/main/java/com/example/sales/model/Product.java
package com.example.sales.model;

import com.example.sales.model.base.BaseEntity;
import jakarta.validation.constraints.NotBlank;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.CompoundIndex;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document("products")
// ƒê·∫£m b·∫£o SKU l√† duy nh·∫•t trong ph·∫°m vi m·ªói shop
@CompoundIndex(def = "{'shopId': 1, 'sku': 1}", unique = true)
public class Product extends BaseEntity {
    @Id
    private String id;

    @NotBlank(message = "T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String name;

    @NotBlank(message = "Danh m·ª•c kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String category;

    @NotBlank(message = "SKU kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String sku; // M√£ s·∫£n ph·∫©m SKU (duy nh·∫•t trong shop)

    private String shopId; // Shop m√† ƒë·ªãnh nghƒ©a s·∫£n ph·∫©m n√†y thu·ªôc v·ªÅ
}

// File: src/main/java/com/example/sales/model/Promotion.java
package com.example.sales.model;

import com.example.sales.constant.DiscountType;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import java.time.LocalDateTime;
import java.util.List;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document(collection = "promotions")
public class Promotion extends BaseEntity {

    @Id
    private String id;

    private String shopId;
    private String branchId;

    private String name;

    private DiscountType discountType; // PERCENT, AMOUNT

    private double discountValue;

    private List<String> applicableProductIds;

    private LocalDateTime startDate;
    private LocalDateTime endDate;

    private boolean active;
}

// File: src/main/java/com/example/sales/model/RefreshToken.java
package com.example.sales.model;

import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import java.util.Date;

@Getter
@Setter
@ToString(exclude = "token") // ‚ùó tr√°nh log token
@NoArgsConstructor
@AllArgsConstructor
@Document(collection = "refresh_tokens")
public class RefreshToken {
    @Id
    private String id;
    private String token;
    private String userId;
    private Date expiryDate;
}

// File: src/main/java/com/example/sales/model/Shop.java
package com.example.sales.model;

import com.example.sales.constant.ShopType;
import com.example.sales.constant.SubscriptionPlan;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import java.time.LocalDateTime;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document(collection = "shops")
public class Shop extends BaseEntity {

    @Id
    private String id;

    private String name;
    private String ownerId;
    private ShopType type;
    private String address;
    private String phone;
    private String logoUrl;

    @Builder.Default
    private boolean active = true;

    // ====== N√¢ng cao (SS) ======
    @Builder.Default
    private boolean trackInventory = true;

    @Builder.Default
    private String currency = "VND";

    @Builder.Default
    private String timezone = "Asia/Ho_Chi_Minh";

    @Builder.Default
    private String orderPrefix = "ORD";

    @Builder.Default
    private SubscriptionPlan plan = SubscriptionPlan.FREE;

    private LocalDateTime planExpiry;
}

// File: src/main/java/com/example/sales/model/ShopUser.java
package com.example.sales.model;

import com.example.sales.constant.Permission;
import com.example.sales.constant.ShopRole;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import java.util.Set;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document(collection = "shop_users")
public class ShopUser extends BaseEntity {
    @Id
    private String id;
    private String shopId;
    private String userId;
    private ShopRole role;
    private String branchId;
    private Set<Permission> permissions;
}

// File: src/main/java/com/example/sales/model/SubscriptionHistory.java
package com.example.sales.model;

import com.example.sales.constant.SubscriptionActionType;
import com.example.sales.constant.SubscriptionPlan;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document("subscription_histories")
public class SubscriptionHistory extends BaseEntity {

    @Id
    private String id;

    private String shopId;
    private String userId;

    private SubscriptionPlan oldPlan;
    private SubscriptionPlan newPlan;
    private int durationMonths;

    private String transactionId;
    private String paymentMethod;
    private SubscriptionActionType actionType;
}

// File: src/main/java/com/example/sales/model/Table.java
package com.example.sales.model;

import com.example.sales.constant.TableStatus;
import com.example.sales.model.base.BaseEntity;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document(collection = "tables")
public class Table extends BaseEntity {
    @Id
    private String id;

    private String shopId;
    private String branchId;
    private String name;
    private TableStatus status;

    private Integer capacity;
    private String note;
    private String currentOrderId;
}

// File: src/main/java/com/example/sales/model/User.java
package com.example.sales.model;

import com.example.sales.constant.UserRole;
import com.example.sales.model.base.BaseEntity;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import java.util.Date;

@Getter
@Setter
@ToString(exclude = {
        "password",
        "verificationToken",
        "resetToken"
}) // üëà Tr√°nh l·ªô th√¥ng tin nh·∫°y c·∫£m & v√≤ng l·∫∑p
@EqualsAndHashCode(callSuper = true)
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Document(collection = "users")
public class User extends BaseEntity {

    @Id
    private String id;

    @Email
    @NotBlank
    private String email;

    @NotBlank
    private String password;

    private String businessType;
    private String shopName;
    private String fullName;
    private String phone;
    private String avatarUrl;

    @Builder.Default
    private boolean verified = false;

    private String verificationToken;
    private Date verificationExpiry;

    @Builder.Default
    private UserRole role = UserRole.ROLE_USER;

    private String resetToken;
    private Date resetTokenExpiry;
}

// File: src/main/java/com/example/sales/model/BranchProduct.java
package com.example.sales.model;

import com.example.sales.model.base.BaseEntity;
import jakarta.validation.constraints.DecimalMin;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import lombok.*;

import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

@Getter
@Setter
@ToString
@EqualsAndHashCode(callSuper = true)
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Document("branch_products") // <-- Collection m·ªõi cho BranchProduct
public class BranchProduct extends BaseEntity {

    @Id
    private String id;

    @NotBlank(message = "Product ID kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String productId; // Li√™n k·∫øt v·ªõi Product (ƒë·ªãnh nghƒ©a chung)

    @NotBlank(message = "Shop ID kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String shopId;

    @NotBlank(message = "Branch ID kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String branchId; // Chi nh√°nh m√† s·∫£n ph·∫©m n√†y thu·ªôc v·ªÅ

    @Min(value = 0, message = "S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c √¢m")
    private int quantity;

    @DecimalMin(value = "0.0", inclusive = false, message = "Gi√° ph·∫£i l·ªõn h∆°n 0")
    private double price;

    @NotBlank(message = "ƒê∆°n v·ªã kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    private String unit;

    private String imageUrl;
    private String description;

    @Builder.Default
    private boolean activeInBranch = true; // Tr·∫°ng th√°i k√≠ch ho·∫°t t·∫°i chi nh√°nh n√†y
}

// File: src/main/java/com/example/sales/repository/BranchProductRepository.java
package com.example.sales.repository;

import com.example.sales.model.BranchProduct;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.Set;

@Repository
public interface BranchProductRepository extends MongoRepository<BranchProduct, String> {

    // T√¨m BranchProduct theo productId v√† branchId (ƒë·∫£m b·∫£o duy nh·∫•t)
    Optional<BranchProduct> findByProductIdAndBranchIdAndDeletedFalse(String productId, String branchId);

    // T√¨m BranchProduct theo ID c·ªßa BranchProduct, shopId v√† branchId
    Optional<BranchProduct> findByIdAndShopIdAndBranchIdAndDeletedFalse(String id, String shopId, String branchId);

    // T√¨m t·∫•t c·∫£ BranchProduct trong m·ªôt shop v√† branch c·ª• th·ªÉ
    Page<BranchProduct> findByShopIdAndBranchIdAndDeletedFalse(String shopId, String branchId, Pageable pageable);

    // T√¨m t·∫•t c·∫£ BranchProduct trong m·ªôt shop (kh√¥ng l·ªçc theo branchId)
    Page<BranchProduct> findByShopIdAndDeletedFalse(String shopId, Pageable pageable);

    // T√¨m c√°c s·∫£n ph·∫©m t·ªìn kho th·∫•p trong m·ªôt branch
    List<BranchProduct> findByShopIdAndBranchIdAndQuantityLessThanAndDeletedFalse(String shopId, String branchId, int threshold);

    // T√¨m c√°c s·∫£n ph·∫©m t·ªìn kho th·∫•p tr√™n to√†n shop (kh√¥ng l·ªçc theo branchId)
    List<BranchProduct> findByShopIdAndQuantityLessThanAndDeletedFalse(String shopId, int threshold);

    // T√¨m ki·∫øm s·∫£n ph·∫©m theo keyword trong t√™n ho·∫∑c danh m·ª•c (t·ª´ Product) v√† branchId
    // ƒê√¢y s·∫Ω l√† m·ªôt query ph·ª©c t·∫°p h∆°n, c·∫ßn join ho·∫∑c s·ª≠ d·ª•ng aggregation.
    // V√¨ MongoRepository kh√¥ng h·ªó tr·ª£ join tr·ª±c ti·∫øp gi·ªØa c√°c collection,
    // ch√∫ng ta s·∫Ω c·∫ßn th·ª±c hi·ªán lookup trong service ho·∫∑c d√πng custom repository.
    // T·∫°m th·ªùi, ch√∫ng ta s·∫Ω vi·∫øt query t√¨m ki·∫øm tr√™n BranchProduct v√† ƒë·ªÉ service join v·ªõi Product.
    // Ho·∫∑c n·∫øu mu·ªën t√¨m ki·∫øm tr·ª±c ti·∫øp, c·∫ßn s·ª≠ d·ª•ng @Query v·ªõi Aggregation.
    // Gi·∫£ ƒë·ªãnh ch√∫ng ta s·∫Ω t√¨m ki·∫øm theo productId v√† sau ƒë√≥ service s·∫Ω l·ªçc theo keyword t·ª´ Product.
    // Ho·∫∑c t·∫°o m·ªôt query ƒë·ªÉ t√¨m ki·∫øm d·ª±a tr√™n name/category c·ªßa master Product.

    // ƒê·ªëi v·ªõi t√¨m ki·∫øm, ch√∫ng ta s·∫Ω c·∫ßn d√πng aggregation trong service ho·∫∑c m·ªôt custom repository
    // ƒë·ªÉ join BranchProduct v·ªõi Product. Ho·∫∑c, n·∫øu t√™n/danh m·ª•c c√≥ th·ªÉ n·∫±m tr√™n BranchProduct (nh∆∞ m√¥ h√¨nh c≈©),
    // th√¨ query s·∫Ω ƒë∆°n gi·∫£n h∆°n. Nh∆∞ng trong m√¥ h√¨nh m·ªõi, name/category n·∫±m ·ªü Product.
    // ƒê·ªÉ gi·ªØ c√°c repository ƒë∆°n gi·∫£n, c√°c h√†m t√¨m ki·∫øm ph·ª©c t·∫°p (li√™n quan ƒë·∫øn join/lookup)
    // s·∫Ω ƒë∆∞·ª£c x√¢y d·ª±ng trong Service ho·∫∑c m·ªôt Custom Repository Impl.
    // V√¨ v·∫≠y, t√¥i s·∫Ω ƒë·ªÉ c√°c query ƒë∆°n gi·∫£n ·ªü ƒë√¢y, v√† b·ªï sung logic join trong ProductServiceImpl.

    // T√¨m t·∫•t c·∫£ BranchProduct theo productId
    List<BranchProduct> findByProductIdAndDeletedFalse(String productId);

    Page<BranchProduct> findByProductIdInAndShopIdAndBranchIdAndDeletedFalse(Set<String> productIds, String shopId, String branchId, Pageable pageable);

    Page<BranchProduct> findByProductIdInAndShopIdAndDeletedFalse(Set<String> productIds, String shopId, Pageable pageable);
}
[END]