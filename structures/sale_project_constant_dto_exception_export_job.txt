[START]
// File: src/main/java/com/example/sales/constant/ApiCode.java
package com.example.sales.constant;

import lombok.Getter;

@Getter
public enum ApiCode {
    // Success
    SUCCESS("2000", "Operation successful"),
    PRODUCT_CREATED("2001", "Product created successfully"),
    USER_UPDATED("2002", "User updated successfully"),
    PASSWORD_CHANGED("2003", "Password changed successfully"),
    EMAIL_SENT("2004", "Email sent successfully"),

    // Validation & Client Errors
    VALIDATION_ERROR("4000", "Validation error"),
    UNAUTHORIZED("4001", "Unauthorized access"),
    ACCESS_DENIED("4002", "Access denied"),
    NOT_FOUND("4003", "Resource not found"),
    INVALID_TOKEN("4004", "Invalid token"),
    ACCOUNT_LOCKED("4005", "Account is locked"),
    REFRESH_TOKEN_EXPIRED("4006", "Refresh token expired"),
    REFRESH_TOKEN_INVALID("4007", "Invalid refresh token"),
    INCORRECT_PASSWORD("4008", "Incorrect password"),
    EMAIL_EXISTS("4009", "Email already exists"),
    EMAIL_NOT_VERIFIED("4010", "Email not verified"),
    ALREADY_VERIFIED("4011", "Email already verified"),
    TOKEN_EXPIRED("4012", "Token expired"),
    VALIDATION_FILE_ERROR("4013", "Invalid file format"),
    ORDER_ALREADY_PAID("4014", "Order already paid"),
    INVALID_STATUS_TRANSITION("4015", "Invalid status transition"),
    PRODUCT_OUT_OF_STOCK("4016", "Product out of stock"),
    DUPLICATE_DATA("4017", "Duplicate data"),
    CANNOT_DELETE_SELF("4018", "Cannot delete self"),
    SHOP_ALREADY_EXISTS("4019", "Shop already exists"),
    PLAN_UPGRADE_REQUIRED("4020", "Plan upgrade required"),

    // System Errors
    INTERNAL_ERROR("5000", "Internal server error"),
    FILE_UPLOAD_FAILED("5001", "File upload failed"),
    FILE_TYPE_NOT_ALLOWED("5002", "File type not allowed"),

    // Business Logic
    PRODUCT_UPDATED("4102", "Product updated successfully"),
    SHOP_NOT_FOUND("4103", "Shop not found"),
    USER_INFO("4107", "User info retrieved"),
    USER_NOT_FOUND("4108", "User not found"),
    BRANCH_NOT_FOUND("4109", "Branch not found"),
    CUSTOMER_NOT_FOUND("4110", "Customer not found"),
    ORDER_NOT_FOUND("4111", "Order not found"),
    PRODUCT_NOT_FOUND("4112", "Product not found"),
    PROMOTION_NOT_FOUND("4113", "Promotion not found"),
    TABLE_NOT_FOUND("4114", "Table not found"),
    USER_DELETED("4115", "User deleted successfully"),
    ORDER_PAYMENT_CONFIRMED("4116", "Order payment confirmed"),
    ORDER_STATUS_UPDATED("4117", "Order status updated"),
    ORDER_LIST("4118", "Order list retrieved"),
    ORDER_CANCELLED("4119", "Order cancelled"),
    ORDER_CREATED("4120", "Order created successfully"),
    ORDER_UPDATED("4120", "Order updated successfully"),
    CUSTOMER_CREATED("4121", "Customer created successfully"),
    CUSTOMER_UPDATED("4122", "Customer updated successfully"),
    CUSTOMER_DELETED("4123", "Customer deleted successfully"),
    CUSTOMER_LIST("4124", "Customer list retrieved"),
    PRODUCT_DELETED("4125", "Product deleted successfully"),
    PRODUCT_LIST("4126", "Product list retrieved"),
    PRODUCT_FOUND("4127", "Product found"),
    PRODUCT_IMPORTED("4128", "Product imported successfully"),
    PRODUCT_STATUS_UPDATED("4129", "Product status updated successfully"),
    PRODUCT_LOW_STOCK("4130", "Low stock products retrieved"),
    PRODUCT_SEARCH_RESULTS("4131", "Product search results retrieved"),
    SHOP_NAME_EXISTS("4132", "Shop name already exists"),
    SHOP_INACTIVE("4133", "Shop is inactive"),
    INVALID_CAPACITY("4134", "Invalid capacity"),
    TABLE_NAME_EXISTS("4135", "Table name already exists"),
    TABLE_OCCUPIED("4136", "Table is occupied"),
    USER_ALREADY_IN_SHOP("4137", "User already in shop"),
    CANNOT_DELETE_ONLY_BRANCH("4138", "Cannot delete the only branch of the shop"),
    INSUFFICIENT_STOCK ("4139", "Insufficient stock for product");

    private final String code;
    private final String message;

    ApiCode(String code, String message) {
        this.code = code;
        this.message = message;
    }

}

// File: src/main/java/com/example/sales/constant/DiscountType.java
package com.example.sales.constant;

public enum DiscountType {
    PERCENT, // Giảm theo %
    AMOUNT   // Giảm cố định số tiền
}

// File: src/main/java/com/example/sales/constant/InventoryType.java
package com.example.sales.constant;

public enum InventoryType {
    IMPORT,
    EXPORT,
    ADJUSTMENT
}

// File: src/main/java/com/example/sales/constant/OrderStatus.java
package com.example.sales.constant;

public enum OrderStatus {
    PENDING,       // Mới tạo
    CONFIRMED,     // Đã xác nhận
    SHIPPING,      // Đang vận chuyển
    COMPLETED,     // Hoàn tất
    CANCELLED      // Đã huỷ
}

// File: src/main/java/com/example/sales/constant/ShopRole.java
package com.example.sales.constant;

public enum ShopRole {
    ADMIN,
    OWNER,
    MANAGER,
    STAFF,
    CASHIER
}

// File: src/main/java/com/example/sales/constant/ShopType.java
package com.example.sales.constant;

import lombok.Getter;

@Getter
public enum ShopType {
    RESTAURANT(false),
    CAFE(false),
    BAR(false),
    GROCERY(true),
    CONVENIENCE(true),
    PHARMACY(true),
    RETAIL(true),
    OTHER(false);

    private final boolean trackInventory;

    ShopType(boolean trackInventory) {
        this.trackInventory = trackInventory;
    }

}

// File: src/main/java/com/example/sales/constant/SubscriptionActionType.java
package com.example.sales.constant;

public enum SubscriptionActionType {
    UPGRADE,          // Người dùng nâng cấp gói
    DOWNGRADE,        // Người dùng chủ động hạ gói
    AUTO_DOWNGRADE,   // Hệ thống tự động hạ gói khi hết hạn
    TRIAL_EXPIRED     // Gói thử nghiệm kết thúc
}

// File: src/main/java/com/example/sales/constant/SubscriptionPlan.java
package com.example.sales.constant;

public enum SubscriptionPlan {
    FREE, PRO, ENTERPRISE
}

// File: src/main/java/com/example/sales/constant/TableStatus.java
package com.example.sales.constant;

public enum TableStatus {
    AVAILABLE,  // Trống
    OCCUPIED,   // Đang có khách
    CLOSED      // Không hoạt động / Khoá
}

// File: src/main/java/com/example/sales/constant/UserRole.java
package com.example.sales.constant;

public enum UserRole {
    ROLE_USER,
    ROLE_ADMIN
}

// File: src/main/java/com/example/sales/dto/branch/BranchRequest.java
package com.example.sales.dto.branch;

import jakarta.validation.constraints.NotBlank;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class BranchRequest {

    @NotBlank(message = "Tên chi nhánh không được để trống")
    private String name;

    private String address;

    private String phone;

    private boolean active = true;
}

// File: src/main/java/com/example/sales/dto/branch/BranchResponse.java
package com.example.sales.dto.branch;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class BranchResponse {
    private String id;
    private String name;
    private String address;
    private String phone;
    private boolean active;
    private String createdAt;
}

// File: src/main/java/com/example/sales/dto/customer/CustomerRequest.java
package com.example.sales.dto.customer;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class CustomerRequest {
    @NotBlank(message = "Tên khách hàng không được để trống")
    private String name;

    private String phone;

    @Email(message = "Email không hợp lệ")
    private String email;

    private String address;

    private String note;
    private String branchId; // Có thể null nếu không phân biệt chi nhánh
}

// File: src/main/java/com/example/sales/dto/customer/CustomerResponse.java
package com.example.sales.dto.customer;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class CustomerResponse {
    private String id;
    private String name;
    private String phone;
    private String email;
    private String address;
    private String note;
}

// File: src/main/java/com/example/sales/dto/customer/CustomerSearchRequest.java
package com.example.sales.dto.customer;

import lombok.Data;

import java.time.LocalDate;

@Data
public class CustomerSearchRequest {
    private String keyword = "";
    private int page = 0;
    private int size = 20;
    private LocalDate fromDate;
    private LocalDate toDate;
    private String sortBy = "createdAt";
    private String sortDir = "desc";
}

// File: src/main/java/com/example/sales/dto/inventory/InventoryRequest.java
package com.example.sales.dto.inventory;

import com.example.sales.constant.InventoryType;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InventoryRequest {
    @NotBlank(message = "Branch ID không được để trống")
    private String branchId; // ID của chi nhánh

    @NotBlank(message = "Branch Product ID không được để trống")
    private String branchProductId; // ID của BranchProduct

    @NotNull(message = "Loại giao dịch không được để trống")
    private InventoryType type; // IMPORT, EXPORT, ADJUSTMENT

    @Min(value = 1, message = "Số lượng phải lớn hơn 0 cho IMPORT/EXPORT")
    // Đối với ADJUSTMENT, có thể chấp nhận newQuantity = 0, nhưng ở đây ta dùng quantity cho cả 3 loại
    private int quantity; // Số lượng thay đổi (cho IMPORT/EXPORT) hoặc số lượng mới (cho ADJUSTMENT)

    private String note;
    private String referenceId; // Dùng cho EXPORT, ví dụ: Order ID
}

// File: src/main/java/com/example/sales/dto/order/OrderItemRequest.java
package com.example.sales.dto.order;

import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@AllArgsConstructor
@NoArgsConstructor
@Data
public class OrderItemRequest {
    @NotBlank
    private String productId;

    @Min(1)
    private int quantity;

    @Min(0)
    private double price;
}

// File: src/main/java/com/example/sales/dto/order/OrderItemResponse.java
package com.example.sales.dto.order;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderItemResponse {
    private String productId;       // ID của Product (master product)
    private String branchProductId; // ID của BranchProduct (sản phẩm cụ thể tại chi nhánh)
    private String productName;
    private int quantity;
    private double price;             // Giá gốc tại thời điểm đặt hàng
    private double priceAfterDiscount; // Giá sau khi áp dụng khuyến mãi
    private String appliedPromotionId; // ID của khuyến mãi đã áp dụng
}

// File: src/main/java/com/example/sales/dto/order/OrderRequest.java
package com.example.sales.dto.order;

import jakarta.validation.Valid;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotEmpty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderRequest {
    @NotBlank(message = "Shop ID không được để trống")
    private String shopId;

    @NotBlank(message = "Branch ID không được để trống")
    private String branchId; // Đơn hàng luôn thuộc về một chi nhánh cụ thể

    private String tableId; // Có thể null nếu không phải đơn hàng tại bàn

    private String note;

    @Valid
    @NotEmpty(message = "Đơn hàng phải có ít nhất một sản phẩm")
    private List<OrderItemRequest> items;

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class OrderItemRequest {
        @NotBlank(message = "Product ID không được để trống")
        private String productId; // Đây là ID của Product master

        @Min(value = 1, message = "Số lượng phải lớn hơn 0")
        private int quantity;
    }
}

// File: src/main/java/com/example/sales/dto/order/OrderResponse.java
package com.example.sales.dto.order;

import com.example.sales.constant.OrderStatus;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderResponse {
    private String id;
    private String shopId;          // ID của cửa hàng
    private String branchId;        // ID của chi nhánh mà đơn hàng thuộc về
    private String tableId;         // ID của bàn (nếu có)
    private String userId;          // ID của người dùng tạo đơn hàng
    private String note;
    private OrderStatus status;     // Trạng thái đơn hàng (PENDING, COMPLETED, CANCELLED, etc.)
    private boolean paid;           // Đã thanh toán chưa
    private String paymentMethod;   // Phương thức thanh toán
    private String paymentId;       // ID giao dịch thanh toán (nếu có)
    private LocalDateTime paymentTime; // Thời gian thanh toán
    private double totalAmount;     // Tổng số lượng sản phẩm (ví dụ: tổng số lượng items)
    private double totalPrice;      // Tổng giá trị đơn hàng sau chiết khấu
    private List<OrderItemResponse> items; // Danh sách các mục trong đơn hàng

    // OrderItemResponse đã được định nghĩa trong OrderService trước đó, nhưng ta có thể định nghĩa lại tại đây cho rõ ràng.
    // Nếu bạn muốn giữ nó là inner class trong OrderService.java (như trong OrderService.java bạn đã cung cấp),
    // thì không cần định nghĩa lại ở đây.
    // Tuy nhiên, việc có một DTO riêng biệt cho OrderItemResponse thường tốt hơn để tái sử dụng.
    // Tôi sẽ định nghĩa nó như một inner static class ở đây để đảm bảo nó tồn tại,
    // hoặc bạn có thể tạo một file OrderItemResponse.java riêng biệt.
    // Để giữ cho tổ chức gọn gàng, tôi sẽ tạo một file riêng cho OrderItemResponse.java
}

// File: src/main/java/com/example/sales/dto/order/OrderUpdateRequest.java
package com.example.sales.dto.order;

import jakarta.validation.Valid;
import jakarta.validation.constraints.Min;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderUpdateRequest {
    private String tableId;
    private String note;

    @Valid
    private List<OrderItemUpdateRequest> items; // Có thể cập nhật danh sách sản phẩm

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class OrderItemUpdateRequest {
        // ID của Product master, không phải BranchProduct ID
        private String productId;

        @Min(value = 1, message = "Số lượng phải lớn hơn 0")
        private int quantity;

        @Min(value = 0, message = "Giá sản phẩm không được âm")
        private double price; // Giá tại thời điểm cập nhật (có thể khác giá hiện tại của sản phẩm)
    }
}

// File: src/main/java/com/example/sales/dto/product/ProductRequest.java
package com.example.sales.dto.product;

import jakarta.validation.constraints.DecimalMin;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * DTO dùng để tạo hoặc cập nhật thông tin sản phẩm tại một chi nhánh cụ thể.
 * Các trường như name, category, sku sẽ ảnh hưởng đến định nghĩa sản phẩm chung (Product).
 * Các trường như price, quantity, unit, imageUrl, description, active sẽ ảnh hưởng đến BranchProduct.
 */
@Data
@Builder(toBuilder = true)
@NoArgsConstructor
@AllArgsConstructor
public class ProductRequest {

    // Các trường ảnh hưởng đến Product (định nghĩa chung)
    @NotBlank(message = "Tên sản phẩm không được để trống")
    private String name;

    @NotBlank(message = "Danh mục không được để trống")
    private String category;

    @NotBlank(message = "SKU không được để trống")
    private String sku; // SKU là duy nhất trong phạm vi shop, dùng để tìm/tạo Product chính

    // Các trường ảnh hưởng đến BranchProduct (chi tiết tại chi nhánh)
    @Min(value = 0, message = "Số lượng không được âm")
    private int quantity;

    @DecimalMin(value = "0.0", inclusive = false, message = "Giá phải lớn hơn 0")
    private double price;

    @NotBlank(message = "Đơn vị tính không được để trống")
    private String unit;

    private String imageUrl;
    private String description;

    // active sẽ được ánh xạ tới activeInBranch của BranchProduct
    @Builder.Default
    private boolean active = true;
}

// File: src/main/java/com/example/sales/dto/product/ProductResponse.java
package com.example.sales.dto.product;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

/**
 * DTO dùng để trả về thông tin chi tiết của một sản phẩm tại một chi nhánh cụ thể.
 * Kết hợp thông tin từ cả Product (định nghĩa chung) và BranchProduct (chi tiết chi nhánh).
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProductResponse {
    // ID của bản ghi BranchProduct
    private String id;

    // ID của định nghĩa sản phẩm chung (từ Product)
    private String productId;

    // Các trường từ Product (định nghĩa chung)
    private String name;
    private String category;
    private String sku;

    // Các trường từ BranchProduct (chi tiết tại chi nhánh)
    private int quantity;
    private double price;
    private String unit;
    private String imageUrl;
    private String description;
    private String branchId;
    private boolean activeInBranch; // Trạng thái kích hoạt tại chi nhánh này

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// File: src/main/java/com/example/sales/dto/product/ProductSearchRequest.java
package com.example.sales.dto.product;

import lombok.Data;

@Data
public class ProductSearchRequest {
    private String keyword = "";
    private String category = "";
    private Boolean active;
    private Double minPrice;
    private Double maxPrice;
    private int page = 0;
    private int size = 20;
    private String sortBy = "createdAt";
    private String sortDir = "desc";
    private String branchId; // nếu có chi nhánh, có thể để null nếu không có
}

// File: src/main/java/com/example/sales/dto/promotion/PromotionRequest.java
package com.example.sales.dto.promotion;

import com.example.sales.constant.DiscountType;
import jakarta.validation.constraints.*;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.List;

@Data
public class PromotionRequest {

    @NotBlank
    private String name;

    @NotNull
    private DiscountType discountType;

    @Positive
    private double discountValue;

    private List<String> applicableProductIds;

    @NotNull
    private LocalDateTime startDate;

    @NotNull
    private LocalDateTime endDate;

    private boolean active = true;
    private String branchId;
}

// File: src/main/java/com/example/sales/dto/promotion/PromotionResponse.java
package com.example.sales.dto.promotion;

import com.example.sales.constant.DiscountType;
import lombok.Builder;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.List;

@Data
@Builder
public class PromotionResponse {
    private String id;
    private String name;
    private DiscountType discountType;
    private double discountValue;
    private List<String> applicableProductIds;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private boolean active;
}

// File: src/main/java/com/example/sales/dto/report/DailyReportResponse.java
package com.example.sales.dto.report;

import lombok.Builder;
import lombok.Data;

import java.time.LocalDate;

@Data
@Builder
public class DailyReportResponse {
    private LocalDate date;
    private long totalOrders;
    private long totalProductsSold;
    private double totalRevenue;
}

// File: src/main/java/com/example/sales/dto/report/ReportRequest.java
package com.example.sales.dto.report;

import com.example.sales.constant.OrderStatus;
import com.example.sales.validation.ValidDateRange;
import lombok.Data;

import java.time.LocalDate;

@Data
@ValidDateRange
public class ReportRequest {
    private LocalDate startDate;
    private LocalDate endDate;
    private OrderStatus status; // optional
}

// File: src/main/java/com/example/sales/dto/report/ReportResponse.java
package com.example.sales.dto.report;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class ReportResponse {
    private long totalOrders;
    private long totalProductsSold;
    private double totalRevenue;
}

// File: src/main/java/com/example/sales/dto/shop/ShopAdminResponse.java
package com.example.sales.dto.shop;

import com.example.sales.constant.ShopType;
import com.example.sales.constant.SubscriptionPlan;
import lombok.Builder;
import lombok.Data;

import java.time.LocalDateTime;

@Data
@Builder
public class ShopAdminResponse {
    private String id;
    private String name;
    private ShopType type;
    private String address;
    private String phone;
    private String logoUrl;
    private boolean active;
    private SubscriptionPlan plan;
    private String currency;
    private String timezone;
    private String orderPrefix;
    private LocalDateTime planExpiry;
}

// File: src/main/java/com/example/sales/dto/shop/ShopRequest.java
package com.example.sales.dto.shop;

import com.example.sales.constant.ShopType;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Pattern;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ShopRequest {
    @NotBlank(message = "Tên cửa hàng không được để trống")
    private String name;

    @NotNull(message = "Loại cửa hàng là bắt buộc")
    private ShopType type;

    @Pattern(regexp = "^\\+?[1-9]\\d{1,14}$", message = "Số điện thoại không hợp lệ")
    private String phone;

    private String address;
}

// File: src/main/java/com/example/sales/dto/shop/ShopResponse.java
package com.example.sales.dto.shop;

import com.example.sales.constant.ShopType;
import com.example.sales.constant.SubscriptionPlan;
import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class ShopResponse {
    private String id;
    private String name;
    private ShopType type;
    private String address;
    private String phone;
    private String logoUrl;
    private boolean active;
    private SubscriptionPlan plan;
    private String currency;
}

// File: src/main/java/com/example/sales/dto/shop/ShopSimpleResponse.java
package com.example.sales.dto.shop;

import com.example.sales.constant.ShopRole;
import com.example.sales.constant.ShopType;
import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class ShopSimpleResponse {
    private String id;
    private String name;
    private ShopType type;
    private String logoUrl;
    private boolean active;
    private ShopRole role; // 👈 vai trò của user trong shop
    private String branchId;     // ✅ Chi nhánh user thuộc về
    private String branchName;   // ✅ Tên chi nhánh
    private String branchAddress;// ✅ Địa chỉ chi nhánh
}

// File: src/main/java/com/example/sales/dto/shopUser/ShopUserResponse.java
package com.example.sales.dto.shopUser;

import com.example.sales.constant.ShopRole;
import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class ShopUserResponse {
    private String shopId;
    private String shopName;
    private ShopRole role;
}

// File: src/main/java/com/example/sales/dto/subscription/UpgradePlanRequest.java
package com.example.sales.dto.subscription;

import com.example.sales.constant.SubscriptionPlan;
import jakarta.validation.constraints.NotNull;
import lombok.Data;

@Data
public class UpgradePlanRequest {
    @NotNull
    private SubscriptionPlan targetPlan;
    private int months = 1; // số tháng đăng ký (default = 1)
}

// File: src/main/java/com/example/sales/dto/table/TableRequest.java
package com.example.sales.dto.table;

import com.example.sales.constant.TableStatus;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class TableRequest {
    @NotBlank
    private String name;

    private TableStatus status = TableStatus.AVAILABLE;
    private String shopId;
    private Integer capacity;
    private String note;
    private String branchId; // Có thể null nếu không phân biệt chi nhánh
}

// File: src/main/java/com/example/sales/dto/table/TableResponse.java
package com.example.sales.dto.table;

import com.example.sales.constant.TableStatus;
import lombok.*;

@Getter
@Setter
@Builder
public class TableResponse {
    private String id;
    private String name;
    private TableStatus status;
    private String shopId;
    private String shopName;
    private Integer capacity;
    private String note;
    private String currentOrderId;
    private String branchId; // Có thể null nếu không phân biệt chi nhánh
}

// File: src/main/java/com/example/sales/dto/table/TableUpdateRequest.java
package com.example.sales.dto.table;

import com.example.sales.constant.TableStatus;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class TableUpdateRequest {
    @NotBlank
    private String name;
    private TableStatus status;
    private String shopId;
    @Min(1)
    private Integer capacity;
    private String note;
    private String branchId;
}

// File: src/main/java/com/example/sales/dto/ApiResponseDto.java
package com.example.sales.dto;

import com.example.sales.constant.ApiCode;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.time.Instant;

/**
 * Generic response class for API responses, including success status, error code, message, data, and timestamp.
 */
@Getter
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponseDto<T> {
    private boolean success;
    private String code;
    private String message;
    private T data;
    private String timestamp;

    /**
     * Creates a successful response with data.
     */
    public static <T> ApiResponseDto<T> success(ApiCode code, T data) {
        return new ApiResponseDto<>(true, code.getCode(), code.getMessage(), data, Instant.now().toString());
    }

    /**
     * Creates a successful response without data.
     */
    public static <T> ApiResponseDto<T> success(ApiCode code) {
        return new ApiResponseDto<>(true, code.getCode(), code.getMessage(), null, Instant.now().toString());
    }

    /**
     * Creates an error response without data.
     */
    public static <T> ApiResponseDto<T> error(ApiCode code) {
        return new ApiResponseDto<>(false, code.getCode(), code.getMessage(), null, Instant.now().toString());
    }

    /**
     * Creates an error response with custom message and data.
     */
    public static <T> ApiResponseDto<T> error(ApiCode code, String message, T data) {
        return new ApiResponseDto<>(false, code.getCode(), message, data, Instant.now().toString());
    }
}

// File: src/main/java/com/example/sales/dto/ChangePasswordRequest.java
package com.example.sales.dto;

import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class ChangePasswordRequest {

    @NotBlank
    private String currentPassword;

    @NotBlank
    private String newPassword;
}
// File: src/main/java/com/example/sales/dto/JwtResponse.java
package com.example.sales.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class JwtResponse {
    private String accessToken;
    private String refreshToken;
}

// File: src/main/java/com/example/sales/dto/LoginRequest.java
package com.example.sales.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class LoginRequest {
    @Email
    private String email;

    @NotBlank
    private String password;
}

// File: src/main/java/com/example/sales/dto/RefreshTokenRequest.java
package com.example.sales.dto;

import lombok.Data;

@Data
public class RefreshTokenRequest {
    private String refreshToken;
}

// File: src/main/java/com/example/sales/dto/RegisterRequest.java
package com.example.sales.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.Size;
import lombok.Data;

@Data
public class RegisterRequest {
    @Email
    private String email;

    @Size(min = 6, message = "Mật khẩu phải từ 6 ký tự")
    private String password;
}

// File: src/main/java/com/example/sales/dto/SalesReportDto.java
package com.example.sales.dto;

import lombok.AllArgsConstructor;
import lombok.Data;

import java.time.LocalDate;

@Data
@AllArgsConstructor
public class SalesReportDto {
    private LocalDate date;
    private long totalOrders;
    private double totalAmount;
}

// File: src/main/java/com/example/sales/dto/UpdateProfileRequest.java
package com.example.sales.dto;

import lombok.Data;

@Data
public class UpdateProfileRequest {
    private String fullName;
    private String phone;
    private String businessType;
}

// File: src/main/java/com/example/sales/exception/BusinessException.java
package com.example.sales.exception;

import com.example.sales.constant.ApiCode;
import lombok.Getter;

@Getter
public class BusinessException extends RuntimeException {
    private final ApiCode error;

    public BusinessException(ApiCode error) {
        super(error.name());
        this.error = error;
    }
}

// File: src/main/java/com/example/sales/exception/GlobalExceptionHandler.java
package com.example.sales.exception;

import com.example.sales.constant.ApiCode;
import com.example.sales.dto.ApiResponseDto;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.context.request.WebRequest;

import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * Xử lý lỗi validation cho các DTO
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponseDto<Map<String, String>>> handleValidationExceptions(
            MethodArgumentNotValidException ex, WebRequest request) {
        Map<String, String> errors = new HashMap<>();
        for (FieldError error : ex.getBindingResult().getFieldErrors()) {
            errors.put(error.getField(), error.getDefaultMessage());
        }
        log.warn("Validation error at {}: {}", request.getDescription(false), errors);
        return ResponseEntity
                .status(HttpStatus.BAD_REQUEST)
                .body(ApiResponseDto.error(ApiCode.VALIDATION_ERROR, ApiCode.VALIDATION_ERROR.getMessage(), errors));
    }

    /**
     * Xử lý lỗi khi người dùng không có quyền truy cập
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponseDto<String>> handleAccessDeniedException(
            AccessDeniedException ex, WebRequest request) {
        log.warn("Access denied at {}: {}", request.getDescription(false), ex.getMessage());
        return ResponseEntity
                .status(HttpStatus.FORBIDDEN)
                .body(ApiResponseDto.error(ApiCode.ACCESS_DENIED, ApiCode.ACCESS_DENIED.getMessage(), ex.getMessage()));
    }

    /**
     * Xử lý lỗi kinh doanh
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponseDto<String>> handleBusinessException(
            BusinessException ex, WebRequest request) {
        log.error("Business error at {}: {} - {}",
                request.getDescription(false), ex.getError().getCode(), ex.getError().getMessage());
        return ResponseEntity
                .status(getHttpStatus(ex.getError()))
                .body(ApiResponseDto.error(ex.getError(), ex.getError().getMessage(), null));
    }

    /**
     * Xử lý các lỗi chung (fallback)
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponseDto<String>> handleAllExceptions(
            Exception ex, WebRequest request) {
        request.getRemoteUser();
        log.error("Internal server error at {} for user {} (requestId: {}): {}",
                request.getDescription(false),
                request.getRemoteUser(),
                request.getHeader("X-Request-ID"),
                ex.getMessage(), ex);
        return ResponseEntity
                .status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(ApiResponseDto.error(ApiCode.INTERNAL_ERROR, ApiCode.INTERNAL_ERROR.getMessage(), ex.getMessage()));
    }

    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<ApiResponseDto<String>> handleIllegalArgumentException(
            IllegalArgumentException ex, WebRequest request) {
        log.warn("Invalid argument at {}: {}", request.getDescription(false), ex.getMessage());
        return ResponseEntity
                .status(HttpStatus.BAD_REQUEST)
                .body(ApiResponseDto.error(ApiCode.VALIDATION_ERROR, ApiCode.VALIDATION_ERROR.getMessage(), ex.getMessage()));
    }

    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<ApiResponseDto<String>> handleHttpMessageNotReadableException(
            HttpMessageNotReadableException ex, WebRequest request) {
        log.warn("Invalid JSON at {}: {}", request.getDescription(false), ex.getMessage());
        return ResponseEntity
                .status(HttpStatus.BAD_REQUEST)
                .body(ApiResponseDto.error(ApiCode.VALIDATION_ERROR, ApiCode.VALIDATION_ERROR.getMessage(), ex.getMessage()));
    }

    /**
     * Ánh xạ ApiCode sang mã trạng thái HTTP
     */
    private HttpStatus getHttpStatus(ApiCode errorCode) {
        return switch (errorCode) {
            case UNAUTHORIZED -> HttpStatus.UNAUTHORIZED;
            case ACCESS_DENIED -> HttpStatus.FORBIDDEN;
            case NOT_FOUND, USER_NOT_FOUND, SHOP_NOT_FOUND, PRODUCT_NOT_FOUND, ORDER_NOT_FOUND,
                    TABLE_NOT_FOUND, BRANCH_NOT_FOUND, CUSTOMER_NOT_FOUND, PROMOTION_NOT_FOUND ->
                    HttpStatus.NOT_FOUND;
            case VALIDATION_ERROR, INVALID_TOKEN, ACCOUNT_LOCKED, REFRESH_TOKEN_EXPIRED,
                    REFRESH_TOKEN_INVALID, INCORRECT_PASSWORD, VALIDATION_FILE_ERROR,
                    PLAN_UPGRADE_REQUIRED, ORDER_ALREADY_PAID, INVALID_STATUS_TRANSITION,
                    PRODUCT_OUT_OF_STOCK, DUPLICATE_DATA, CANNOT_DELETE_SELF, SHOP_ALREADY_EXISTS,
                    EMAIL_EXISTS, ALREADY_VERIFIED, TOKEN_EXPIRED, EMAIL_NOT_VERIFIED ->
                    HttpStatus.BAD_REQUEST;
            case INTERNAL_ERROR, FILE_UPLOAD_FAILED, FILE_TYPE_NOT_ALLOWED ->
                    HttpStatus.INTERNAL_SERVER_ERROR;
            default -> HttpStatus.OK;
        };
    }
}

// File: src/main/java/com/example/sales/exception/ResourceNotFoundException.java
package com.example.sales.exception;

import com.example.sales.constant.ApiCode;
import lombok.Getter;

@Getter
public class ResourceNotFoundException extends RuntimeException {
    private final ApiCode error;

    public ResourceNotFoundException(ApiCode error) {
        super(error.name());
        this.error = error;
    }
}

// File: src/main/java/com/example/sales/export/GenericExcelExporter.java
package com.example.sales.export;

import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import java.io.IOException;
import java.io.OutputStream; // Import OutputStream
import java.util.List;
import java.util.function.Function;

public class GenericExcelExporter<T> {

    /**
     * Xuất dữ liệu vào một file Excel.
     *
     * @param sheetName Tên của sheet.
     * @param headers Danh sách các tiêu đề cột.
     * @param data Danh sách dữ liệu cần xuất.
     * @param rowMapper Hàm ánh xạ một đối tượng T thành một danh sách các String cho một hàng.
     * @param outputStream OutputStream để ghi dữ liệu Excel.
     * @throws IOException Nếu có lỗi trong quá trình ghi file.
     */
    public void export(String sheetName,
                       List<String> headers,
                       List<T> data,
                       Function<T, List<String>> rowMapper,
                       OutputStream outputStream) throws IOException {
        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet(sheetName);

            // Tạo hàng tiêu đề
            Row headerRow = sheet.createRow(0);
            for (int i = 0; i < headers.size(); i++) {
                Cell cell = headerRow.createCell(i);
                cell.setCellValue(headers.get(i));
            }

            // Ghi dữ liệu
            int rowNum = 1;
            for (T item : data) {
                Row row = sheet.createRow(rowNum++);
                List<String> rowData = rowMapper.apply(item);
                for (int i = 0; i < rowData.size(); i++) {
                    Cell cell = row.createCell(i);
                    cell.setCellValue(rowData.get(i));
                }
            }

            // Tự động điều chỉnh độ rộng cột (tùy chọn)
            for (int i = 0; i < headers.size(); i++) {
                sheet.autoSizeColumn(i);
            }

            workbook.write(outputStream); // Ghi workbook vào OutputStream
        }
    }
}

// File: src/main/java/com/example/sales/job/ImageCleanupJob.java
package com.example.sales.job;

import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.io.File;
import java.time.Instant;
import java.time.temporal.ChronoUnit;

@Slf4j
@Component
public class ImageCleanupJob {

    private static final String TEMP_FOLDER = "uploads/temp";
    private static final long EXPIRE_MINUTES = 30;

    @Scheduled(fixedRate = 15 * 60 * 1000) // mỗi 15 phút
    public void cleanUpTempImages() {
        File dir = new File(TEMP_FOLDER);
        if (!dir.exists() || !dir.isDirectory()) return;

        File[] files = dir.listFiles();
        if (files == null) return;

        Instant now = Instant.now();

        for (File file : files) {
            if (file.isFile()) {
                long lastModified = file.lastModified();
                Instant modifiedTime = Instant.ofEpochMilli(lastModified);
                if (modifiedTime.isBefore(now.minus(EXPIRE_MINUTES, ChronoUnit.MINUTES))) {
                    boolean deleted = file.delete();
                    log.info("Deleted temp image {}: {}", file.getName(), deleted);
                }
            }
        }
    }
}

// File: src/main/java/com/example/sales/scheduler/PlanExpiryScheduler.java
package com.example.sales.scheduler;

import com.example.sales.constant.SubscriptionActionType;
import com.example.sales.constant.SubscriptionPlan;
import com.example.sales.model.Shop;
import com.example.sales.model.SubscriptionHistory;
import com.example.sales.model.User;
import com.example.sales.repository.ShopRepository;
import com.example.sales.repository.SubscriptionHistoryRepository;
import com.example.sales.repository.UserRepository;
import com.example.sales.service.MailService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Component
@RequiredArgsConstructor
@Slf4j
public class PlanExpiryScheduler {

    private final ShopRepository shopRepository;
    private final SubscriptionHistoryRepository historyRepository;
    private final MailService emailService; // Giả sử bạn có một service gửi email
    private final UserRepository userRepository; // Giả sử bạn có repository để lấy thông tin người dùng

    // Chạy mỗi ngày lúc 01:00 sáng
    @Scheduled(cron = "0 0 1 * * *")
    public void downgradeExpiredPlans() {
        log.info("🔄 Kiểm tra gói đã hết hạn...");

        List<Shop> expiredShops = shopRepository.findByPlanExpiryBeforeAndPlanNot(LocalDateTime.now(), SubscriptionPlan.FREE);

        for (Shop shop : expiredShops) {
            SubscriptionPlan oldPlan = shop.getPlan();
            log.info("⚠️ Shop {} đã hết hạn gói {} → hạ về FREE", shop.getId(), shop.getPlan());
            shop.setPlan(SubscriptionPlan.FREE);
            shop.setPlanExpiry(null); // hoặc giữ nguyên nếu muốn log

            // Ghi lịch sử
            SubscriptionHistory history = SubscriptionHistory.builder()
                    .shopId(shop.getId())
                    .userId(shop.getOwnerId())
                    .oldPlan(oldPlan)
                    .newPlan(SubscriptionPlan.FREE)
                    .durationMonths(0)
                    .paymentMethod("AUTO")
                    .actionType(SubscriptionActionType.AUTO_DOWNGRADE)
                    .build();

            historyRepository.save(history);

            User owner = userRepository.findById(shop.getOwnerId()).orElse(null);
            if (owner != null && owner.getEmail() != null) {
                Map<String, Object> model = Map.of(
                        "fullName", owner.getFullName(),
                        "oldPlan", oldPlan.name(),
                        "shopName", shop.getName()
                );

                emailService.sendHtmlTemplate(
                        owner.getEmail(),
                        "Gói dịch vụ của bạn đã hết hạn",
                        "emails/plan-downgraded",
                        model
                );
            }
        }

        shopRepository.saveAll(expiredShops);
    }
}

// File: src/main/java/com/example/sales/scheduler/PlanReminderScheduler.java
package com.example.sales.scheduler;

import com.example.sales.model.Shop;
import com.example.sales.model.User;
import com.example.sales.repository.ShopRepository;
import com.example.sales.repository.UserRepository;
import com.example.sales.service.MailService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.List;
import java.util.Map;

@Component
@RequiredArgsConstructor
@Slf4j
public class PlanReminderScheduler {

    private final ShopRepository shopRepository;
    private final UserRepository userRepository;
    private final MailService mailService;

    // Chạy mỗi ngày lúc 7h sáng
    @Scheduled(cron = "0 0 7 * * *")
    public void remindExpiringPlans() {
        LocalDateTime targetDate = LocalDateTime.now().plusDays(3).truncatedTo(ChronoUnit.DAYS);

        List<Shop> shops = shopRepository.findByPlanExpiryBetween(
                targetDate,
                targetDate.plusDays(1)
        );

        for (Shop shop : shops) {
            User owner = userRepository.findById(shop.getOwnerId()).orElse(null);
            if (owner == null || owner.getEmail() == null) continue;

            Map<String, Object> model = Map.of(
                    "fullName", owner.getFullName(),
                    "shopName", shop.getName(),
                    "expiryDate", shop.getPlanExpiry().toLocalDate(),
                    "currentPlan", shop.getPlan().name()
            );

            mailService.sendHtmlTemplate(
                    owner.getEmail(),
                    "⏳ Gói " + shop.getPlan() + " sắp hết hạn",
                    "emails/plan-expiry-reminder",
                    model
            );

            log.info("📧 Đã gửi email nhắc hạn cho shop {}", shop.getName());
        }
    }
}

// File: src/main/java/com/example/sales/dto/inventory/InventoryTransactionResponse.java
package com.example.sales.dto.inventory;

import com.example.sales.constant.InventoryType;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data // Bao gồm @Getter, @Setter, @EqualsAndHashCode, @ToString
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InventoryTransactionResponse {
    private String id;
    private String shopId;
    private String branchId;
    private String branchProductId; // ID của BranchProduct liên quan đến giao dịch
    private String productName;     // Tên của sản phẩm (từ Product master)
    private InventoryType type;     // Loại giao dịch (IMPORT, EXPORT, ADJUSTMENT)
    private int quantity;           // Số lượng thay đổi trong giao dịch
    private String note;
    private String referenceId;     // ID tham chiếu (ví dụ: Order ID)
    private LocalDateTime createdAt;
    private String createdBy;       // ID người dùng thực hiện giao dịch
}

// File: src/main/java/com/example/sales/cache/OrderCache.java
package com.example.sales.cache;

import com.example.sales.constant.ApiCode;
import com.example.sales.exception.ResourceNotFoundException;
import com.example.sales.model.Order;
import com.example.sales.repository.OrderRepository;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Component;

@Component
public class OrderCache {

    private final OrderRepository orderRepository;

    public OrderCache(OrderRepository orderRepository) {
        this.orderRepository = orderRepository;
    }

    @Cacheable(value = "orders", key = "#shopId + ':' + #orderId")
    public Order getOrderByShop(String orderId, String shopId) {
        return orderRepository.findByIdAndDeletedFalse(orderId)
                .filter(o -> o.getShopId().equals(shopId))
                .orElseThrow(() -> new ResourceNotFoundException(ApiCode.ORDER_NOT_FOUND));
    }
}

// File: src/main/java/com/example/sales/constant/Permission.java
package com.example.sales.constant;

public enum Permission {
    PRODUCT_CREATE,
    PRODUCT_UPDATE,
    PRODUCT_DELETE,
    ORDER_CREATE,
    ORDER_UPDATE,
    ORDER_CANCEL,
    ORDER_PAYMENT_CONFIRM,
    ORDER_VIEW,
    CUSTOMER_VIEW,
    CUSTOMER_UPDATE,
    SHOP_MANAGE,
    CUSTOMER_DELETE,
    BRANCH_UPDATE,
    PRODUCT_IMPORT,
    PRODUCT_EXPORT,
    PRODUCT_UPDATE_STATUS,
    PRODUCT_VIEW_LOW_STOCK,
    PROMOTION_CREATE,
    PROMOTION_UPDATE,
    PROMOTION_DELETE,
    PROMOTION_VIEW,
    TABLE_CREATE,
    TABLE_UPDATE,
    TABLE_DELETE,
    TABLE_VIEW,
    SHOP_USER_CREATE,
    SHOP_USER_UPDATE,
    SHOP_USER_DELETE,
    SHOP_USER_BRANCH_DELETE,
    SHOP_USER_VIEW,
    BRANCH_MANAGE,
    BRANCH_VIEW,
    INVENTORY_VIEW,
    INVENTORY_MANAGE,
    REPORT_VIEW
}
[END]